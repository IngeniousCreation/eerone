#!/usr/bin/env php
<?php
/**
 * Simple WordPress Malware Scanner
 * Scans for common malware patterns
 */

$patterns = [
    'eval with hex encoding' => '/eval.*\\\\x[0-9a-f]{2}/i',
    'base64_decode' => '/base64_decode\s*\(/i',
    'gzinflate' => '/gzinflate\s*\(/i',
    'str_rot13' => '/str_rot13\s*\(/i',
    'eval POST/GET/REQUEST' => '/@?eval\s*\(\s*\$_(POST|GET|REQUEST|COOKIE|SERVER|HEADERS)/i',
    'getallheaders with eval' => '/getallheaders.*@?eval/i',
    'Feature-Policy header exploit' => '/Feature-Policy.*eval/i',
    'system/exec/shell_exec' => '/(system|exec|shell_exec|passthru|popen|proc_open)\s*\(\s*\$_(POST|GET|REQUEST)/i',
    'file_put_contents with eval' => '/file_put_contents.*eval/i',
    'assert with variable' => '/assert\s*\(\s*\$_(POST|GET|REQUEST)/i',
    'preg_replace /e modifier' => '/preg_replace\s*\(.*\/.*e/i',
    'create_function' => '/create_function\s*\(/i',
];

$suspicious_files = [];
$total_files = 0;

function scanDirectory($dir, $patterns) {
    global $suspicious_files, $total_files;
    
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS),
        RecursiveIteratorIterator::SELF_FIRST
    );
    
    foreach ($iterator as $file) {
        if ($file->isFile() && $file->getExtension() === 'php') {
            $total_files++;
            $filepath = $file->getPathname();
            $content = file_get_contents($filepath);
            
            foreach ($patterns as $name => $pattern) {
                if (preg_match($pattern, $content, $matches)) {
                    if (!isset($suspicious_files[$filepath])) {
                        $suspicious_files[$filepath] = [];
                    }
                    $suspicious_files[$filepath][] = [
                        'pattern' => $name,
                        'match' => substr($matches[0], 0, 100)
                    ];
                }
            }
            
            // Show progress
            if ($total_files % 100 === 0) {
                echo "Scanned $total_files files...\n";
            }
        }
    }
}

echo "WordPress Malware Scanner\n";
echo "=========================\n\n";

$scan_dir = $argv[1] ?? 'wp-content';

if (!is_dir($scan_dir)) {
    echo "Error: Directory '$scan_dir' not found\n";
    exit(1);
}

echo "Scanning directory: $scan_dir\n\n";

scanDirectory($scan_dir, $patterns);

echo "\n=========================\n";
echo "Scan Complete!\n";
echo "Total files scanned: $total_files\n";
echo "Suspicious files found: " . count($suspicious_files) . "\n\n";

if (count($suspicious_files) > 0) {
    echo "SUSPICIOUS FILES:\n";
    echo "=================\n\n";
    
    foreach ($suspicious_files as $file => $detections) {
        echo "FILE: $file\n";
        foreach ($detections as $detection) {
            echo "  - Pattern: {$detection['pattern']}\n";
            echo "    Match: {$detection['match']}\n";
        }
        echo "\n";
    }
    
    exit(1);
} else {
    echo "No malware patterns detected!\n";
    exit(0);
}

